#!/bin/bash

# this exports pyproject.toml deps to a standard requirements.txt file.
# Mainly for hosts that do not support pyproject.toml.
# Run this every time you add new dependencies!

CWD=$(pwd)

if [[ $@ == *"--help"* ]]; then
    echo "bin/export: Export dependencies to requirements.txt files."
    echo "Usage: $0 [options]"
    echo "Options:"
    echo "  --help        Show this help message and exit"
    echo "  --incl-dev    Export dev and no-dev dependencies to separate files, this is the default behavior"
    echo "  --only-dev    Export only dev dependencies to requirements-dev.txt"
    echo "  --no-dev      Export only no-dev dependencies to requirements.txt"
    exit 0
fi

if [[ $@ == *"--incl-dev"* ]]; then
    echo "Will export no-dev dependencies to requirements.txt."
    echo "Will also export dev dependencies to requirements-dev.txt."
    EXPT_NO_DEV=true
    EXPT_DEV=true
elif [[ $@ == *"--only-dev"* ]]; then
    echo "Will export dev dependencies to requirements-dev.txt."
    EXPT_DEV=true
    EXPT_NO_DEV=false
elif [[ $@ == *"--no-dev"* ]]; then
    echo "Will export no-dev dependencies to requirements.txt."
    EXPT_NO_DEV=true
    EXPT_DEV=false
else
    echo "Will export no-dev dependencies to requirements.txt."
    echo "Will also export dev dependencies to requirements-dev.txt."
    EXPT_NO_DEV=true
    EXPT_DEV=true
fi

if [[ $@ == *"--dry-run"* ]]; then
    echo "Dry run mode, no files will be altered."
    EXPT_DRY_RUN=true
else
    EXPT_DRY_RUN=false
fi

get_script_dir()
{
    local SOURCE_PATH="${BASH_SOURCE[0]}"
    local SYMLINK_DIR
    local SCRIPT_DIR
    # Resolve symlinks recursively
    while [ -L "$SOURCE_PATH" ]; do
        # Get symlink directory
        SYMLINK_DIR="$( cd -P "$( dirname "$SOURCE_PATH" )" >/dev/null 2>&1 && pwd )"
        # Resolve symlink target (relative or absolute)
        SOURCE_PATH="$(readlink "$SOURCE_PATH")"
        # Check if candidate path is relative or absolute
        if [[ $SOURCE_PATH != /* ]]; then
            # Candidate path is relative, resolve to full path
            SOURCE_PATH=$SYMLINK_DIR/$SOURCE_PATH
        fi
    done
    # Get final script directory path from fully resolved source path
    SCRIPT_DIR="$(cd -P "$( dirname "$SOURCE_PATH" )" >/dev/null 2>&1 && pwd)"
    echo "$SCRIPT_DIR"
}

SCRIPT_DIR=$(get_script_dir)
# Root will be one level up from the script dir
KORU_ROOT=$(dirname "$SCRIPT_DIR")


if ! command -v uv &>/dev/null; then
    echo "uv is not installed, please install it with 'pip install uv' and try again."
    exit 1
fi

if [[ -f "$KORU_ROOT/requirements.txt" ]] && [[ $EXPT_NO_DEV == true ]]; then
    echo "Removing existing requirements.txt..."
    if [[ $EXPT_DRY_RUN == true ]]; then
        echo "(Dry run) rm \"$KORU_ROOT/requirements.txt\""
    else
        rm "$KORU_ROOT/requirements.txt"
    fi
fi

if [[ -f "$KORU_ROOT/requirements-dev.txt" ]] && [[ $EXPT_DEV == true ]]; then
    echo "Removing existing requirements-dev.txt..."
    if [[ $EXPT_DRY_RUN == true ]]; then
        echo "(Dry run) rm \"$KORU_ROOT/requirements-dev.txt\""
    else
        rm "$KORU_ROOT/requirements-dev.txt"
    fi
fi

if [[ $EXPT_NO_DEV == true ]]; then
    echo "Exporting no-dev dependencies to requirements.txt..."
    if [[ $EXPT_DRY_RUN == true ]]; then
        echo "(Dry run) printf -v date '%(%Y-%m-%d %H:%M:%S)T\n' -1"
        echo "(Dry run) echo \"# Generated by bin/export on \$date\" > \"$KORU_ROOT/requirements.txt\""
        echo "(Dry run) uv export --no-dev --format requirements.txt > \"$KORU_ROOT/requirements.txt\""
    else
        printf -v date '%(%Y-%m-%d %H:%M:%S)T\n' -1
        echo "# Generated by bin/export on $date" > "$KORU_ROOT/requirements.txt"
        uv export --no-dev --format requirements.txt >> "$KORU_ROOT/requirements.txt"
    fi
fi

if [[ $EXPT_DEV == true ]]; then
    echo "Exporting dev dependencies to requirements-dev.txt..."
    if [[ $EXPT_DRY_RUN == true ]]; then
        echo "(Dry run) printf -v date '%(%Y-%m-%d %H:%M:%S)T\n' -1"
        echo "(Dry run) echo \"# Generated by bin/export on \$date\" > \"$KORU_ROOT/requirements-dev.txt\""
        echo "(Dry run) uv export --format requirements.txt > \"$KORU_ROOT/requirements-dev.txt\""
    else
        printf -v date '%(%Y-%m-%d %H:%M:%S)T\n' -1
        echo "# Generated by bin/export on $date" > "$KORU_ROOT/requirements-dev.txt"
        uv export --format requirements.txt >> "$KORU_ROOT/requirements-dev.txt"
    fi
fi